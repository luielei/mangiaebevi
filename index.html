<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDfZJSUEUjG6-qci54dZMq-EzjxRHbfgXQ",
    authDomain: "mangiaebevi-2025.firebaseapp.com",
    projectId: "mangiaebevi-2025",
    storageBucket: "mangiaebevi-2025.firebasestorage.app",
    messagingSenderId: "549316049300",
    appId: "1:549316049300:web:4d999af64d9e7b8ea97781"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const dbRef = ref(db, 'spese');
  onValue(dbRef, (snapshot) => {
    const data = snapshot.val();
    const totals = [];

    for (const squadra in data) {
      const spese = data[squadra];
      const totale = spese.reduce((sum, val) => sum + parseFloat(val), 0);
      const nomeVisuale = squadra.replace(/_/g, ' ').toUpperCase(); // opzionale: migliora visualizzazione
      totals.push({ squadra: nomeVisuale, totale });
    }

    totals.sort((a, b) => b.totale - a.totale);

    // Popola tabella
    const tbody = document.querySelector("#classifica tbody");
    tbody.innerHTML = '';
    totals.forEach((t, idx) => {
      const tr = document.createElement("tr");
      if (idx === 0) tr.classList.add("highlight");
      tr.innerHTML = `<td>${t.squadra}</td><td>${t.totale.toFixed(2)}</td>`;
      tbody.appendChild(tr);
    });
    new DataTable('#classifica', {
      order: [[1, 'desc']]
    });

    // Crea grafico top 5
    const top5 = totals.slice(0, 5);
    const ctx = document.getElementById('speseChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: top5.map(t => t.squadra),
        datasets: [{
          label: 'Spese CHF',
          data: top5.map(t => t.totale),
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { beginAtZero: true }
        },
        plugins: {
          legend: {
            display: false
          }
        }
      }
    });
  });
</script>
